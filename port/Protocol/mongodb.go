package Protocol

import (
	"net"
	"time"
)

// IsMongoDBProtocol MongoDB 协议识别
func IsMongoDBProtocol(conn net.Conn) bool {
	conn.SetReadDeadline(time.Now().Add(time.Second * 5))

	// 构造 isMaster 查询命令
	packet := []byte{
		0x3a, 0x00, 0x00, 0x00, // 消息长度（包括自身）
		0x01, 0x00, 0x00, 0x00, // 请求ID
		0x00, 0x00, 0x00, 0x00, // 响应ID
		0xd4, 0x07, 0x00, 0x00, // OP_QUERY 操作码
		0x00, 0x00, 0x00, 0x00, // 标志位
		0x24, 0x00, 0x00, 0x00, // fullCollectionName admin.$cmd
		0x00, 0x00, 0x00, 0x00, // numberToSkip
		0x01, 0x00, 0x00, 0x00, // numberToReturn
		// query {isMaster: 1}
		0x14, 0x00, 0x00, 0x00, 0x10, 0x69, 0x73, 0x4d, 0x61, 0x73, 0x74, 0x65, 0x72, 0x00, 0x01, 0x00, 0x00, 0x00,
	}

	_, err := conn.Write(packet)
	if err != nil {
		return false
	}

	reply := make([]byte, 1024)
	_, err = conn.Read(reply)
	if err == nil {
		return true
	}

	return false
}
